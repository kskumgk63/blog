---
title: "Webアプリ作るなら必須！Cookieについて勉強しました"
date: 2020-04-29T07:32:49+09:00
draft: false

categories: ["web"]
tags: ["cookie"]
author: "Keisuke Umegaki"
---

# Cookieについて改めて勉強しました
仕事で認可サーバーにふれる機会が増えているので、ぼんやりと理解していたCookieを正しく知ろうと思い立ちいろいろと検索をしていたらCookieとCacheの違いを説明している記事が多く、純粋にCookieについて教えてくれる記事が少なそうだったので書きました。

勉強して思ったのは、Cookieを正しく知らないでWebアプリケーションを開発することは非常に危険だということです。Cookieの理解が曖昧だとセキュリティ問題に繋がる可能性が高いです。
Cookie起因のWebサービスの脆弱性は、ユーザーのログイン状態が奪われるなど影響が大きく、万が一、発生すると会社の信頼がどん底に落ちてしまいます。
Cookieについて正しく理解して防げる脆弱性は潰していきましょう！

本記事では、Cookieとは何か、どんな使われ方をするのか、Cookieが絡むセキュリティ問題について書いています。

[RFC6265](https://tools.ietf.org/html/rfc6265)に世界標準のCookieの仕様が載っているので適宜参照してください。

## まず、ひとことでCookieとは？
ステートレスなHTTP通信でも一人ひとりに違う内容のページを表示させたり、前回のアクセスの続きとして対応することを可能にするために個人を識別する会員証のように扱われ、
Webサーバーからユーザーのwebブラウザに送られる、ユーザーのデータを保存しておくためのファイルのことです。

ステートレス：サーバーなどのシステムが現在の状態を表すデータ（ログイン状態等）を保持せず、入力の内容によってのみ出力が決まる方式です。同じ入力に対する出力は常に同じになります。

[（出典）ステートレスとは - IT用語辞典 e-Words](http://e-words.jp/w/%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%AC%E3%82%B9.html)

## どんな使われ方をするのか？
個人を識別できることから以下の利用方法が代表的です。

- Webサービスへのログイン状態の保持
- ECサイトの買い物かご機能
- 広告の最適化

Cookieはログイン状態の保持に使われることから攻撃者は、そのログイン状態を奪いにかかります。ログイン状態を奪われるとあなたのログインしているWebサービスを勝手に攻撃者に使われることになります。

## Cookieの属性
Cookieはサーバーからブラウザへと送信され、Cookieをブラウザ上でどのように扱ってほしいか指定する「属性」を付与することができます。
注意点としては、ブラウザからサーバーへのリクエストでは、属性を指定できません。つまりCookieの属性が指定していできるのは、`サーバー -> ブラウザ` の一方向のみです。

### Path
パス毎に異なるセッションIDを発行したいというときに有効な属性です。例えば、pathによってサービスが違う場合に使えます。
ただし、異なるパスへのCookie付与はできてしまうため、安全性は保証されません。

### Domain
デフォルト状態であるこの属性を指定しないCookieが一番安全と言われています。

[CookieのDomain属性は *指定しない* が一番安全](https://blog.tokumaru.org/2011/10/cookiedomain.html)

Domain属性を指定しないCookieは、Cookieを発行したホストのみに送信されます。サブドメインへは送信されません。
デフォルト状態が送信される範囲が最も狭く安全であると言えます。

逆にDomain属性を指定すると、サブドメインを含むホストへ送信されます。

`Domain=hoge.com` を指定したCookieは、`foo.hoge.com`へも送信されます。
Domain属性なしのCookieは、`hoge.com`にしか送信されません。

### Secure
ブラウザからサーバー間の通信がHTTPSの場合のみCookieも一緒に送信されます。
もしCookieをセッション情報の管理使用する場合は設定必須の項目です。
万が一、この属性を付与せずにセッション管理に使っていると暗号化されていない平文でリクエストが送信されるのでセッション情報が盗聴される可能性があります。

### Max-Age
クッキーの残存期間を秒数で指定でき、例えば`Max-Age=1000`であれば1000秒後に消滅します。
負の値を指定すると、最も過去の日付を指定したことになります。
指定しなければ、ブラウザが終了するとCookieが削除されます。

### Expires
有効期限が切れる日付・時刻を指定します。
指定しなければ、ブラウザが終了するとCookieが削除されます。
この属性を指定するとブラウザを終了しても認証状態を維持することができます。

### `Max-Age`と`Expires`の違い
有効期限を指定する点は似ていますが、`Max-Age`が秒数指定、`Expires`が日時指定であることが大きく違います。
また、`Max-Age` `Expires` が両方設定されていると`Max-Age`が優先されます。`Max-Age > Expires`

### HttpOnly
JavaScriptから参照することができません。基本的にセッションIDをJavaScriptから読み取らせる意味は無いので指定したほうがいいでしょう。
この属性を指定することでXSSなどで悪意のあるスクリプトによって値が読み取られることを防げますが根本的な対策になるわけではありません。

## Cookieの脆弱性を狙った攻撃

### クロスサイトスクリプティング（Cross Site Scripting, XSS）
HTMLの生成の実装に問題があるとXSSという脆弱性が発生します。この影響はたとえば、攻撃者がJavaScriptを実行してクッキーを盗み出しログイン状態を奪われることがあります。
これを防ぐためにCookieの`HttpOnly`属性を有効化します。そうすることでJavaScriptからクッキーを盗み出されることがなくなります。

しかし、この脆弱性はHTML生成の実装方法に問題があることがから発生している脆弱性なので、Cookieの属性を指定するだけでは十分な対策とは言えませんが、`HttpOnly`を有効にするだけなのでしない他ないでしょう。
ここでは、XSSの具体的な対策方法に関しては、Cookieの学習からそれるので割愛しますが、おすすめの解説記事を紹介します。

- [徳丸本から学ぶクロスサイト・スクリプティング基礎](https://system.blog.uuum.jp/entry/2016/07/27/110000)
- [クロスサイトスクリプティング（XSS）のセキュリティ対策とは？](https://www.shadan-kun.com/blog/measure/1052/)

ちなみに「徳丸本」とは、徳丸浩さんが書かれた[体系的に学ぶ 安全なWebアプリケーションの作り方](https://www.amazon.co.jp/dp/B07DVY4H3M/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1)のことです。
Webアプリケーションのセキュリティを考える上では非常に勉強になる名著です。

### CookieのSecure属性を指定しないことによる脆弱性
Secure属性とは前述したとおり、HTTPS通信ときのみCookieを送信する制限を設けるための属性です。Secure属性がついていないCookieは暗号化されずに送信されることがあり盗聴されてログイン状態を奪われる可能性があります。
WebアプリケーションでHTTPしか使っていないなら、まずはHTTPSにするところからはじめてCookieの属性にはSecure属性を付けましょう。

## Cookieに保存しないほうがいいデータとは？
ユーザーIDや権限情報などの書き換えられたくないデータはCookieに保存しないようにするべきです。

Cookieはブラウザから書き換えることができるので、Webアプリケーションが扱うデータの中でユーザーから勝手に書き換えられたくない（サーバーが意図しない）ものはCookieに保存するべきではないです。

[Chrome拡張機能「EditThisCookie」 - クッキーを表示・編集](https://webkaru.net/dev/google-chrome-extension-editthiscookie/)

なので基本的には、セッションIDのみをCookieに保存するべきです。ユーザーIDや権限情報をCookieに保存することは脆弱性に繋がります。
Cookieは、サーバーをまたがって使用できるので、セッション維持には向いていると言えます。

# 最後に
この記事を読んで、Cookieの基礎を理解して、Cookieを正しく使えないとWebアプリケーションに脆弱性を生むことを理解していただければ幸いです。
